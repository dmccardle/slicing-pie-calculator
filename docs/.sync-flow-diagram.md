# Documentation Sync Flow Diagram

## Three-Tier Architecture

```mermaid
graph TB
    subgraph "Tier 1: Base Template"
        A[claude-code-docs-template]
        A1[Push to docs/]
        A2[GitHub Action: sync-downstream.yml]
    end

    subgraph "Tier 2: Architecture Templates"
        B1[saas-fullstack-template]
        B2[marketing-website-template]
        B3[Webhook Receiver]
        B4[Create Sync Branch]
        B5[Run CI Tests]
        B6[Create PR for Review]
        B7[Human Approval Required]
    end

    subgraph "Tier 3: Actual Projects"
        C1[my-startup-app]
        C2[another-saas-app]
        C3[company-website]
        C4[Same PR Process]
    end

    A1 --> A2
    A2 -->|repository_dispatch| B3
    A2 -->|repository_dispatch| B2

    B3 --> B4
    B4 --> B5
    B5 -->|Tests Pass| B6
    B5 -->|Tests Fail| H[Create Issue]
    B6 --> B7
    B7 -->|Approved| I[Merge to Main]
    B7 -->|Rejected| J[Close PR]

    I -->|Triggers downstream| C1
    I -->|Triggers downstream| C2

    B2 -->|Same process| C3
    C3 --> C4
```

## Sync Process Detail

```mermaid
sequenceDiagram
    participant Base as Base Template
    participant GHA as GitHub Actions
    participant Down as Downstream Repo
    participant CI as CI/CD Tests
    participant Human as Human Reviewer
    participant Main as Main Branch

    Base->>GHA: Push to docs/
    GHA->>Down: Send webhook (repository_dispatch)
    Down->>Down: Create sync branch
    Down->>Down: Merge upstream/main (docs only)
    Down->>Down: Restore custom files
    Down->>CI: Run tests

    alt Tests Pass
        CI->>GHA: Success ✅
        GHA->>Down: Create Pull Request
        Down->>Human: Request review

        alt Human Approves
            Human->>Main: Approve & Merge
            Main->>GHA: Trigger downstream sync
        else Human Rejects
            Human->>Down: Close PR
        end
    else Tests Fail
        CI->>GHA: Failure ❌
        GHA->>Down: Create Issue (manual fix needed)
    end
```

## Safety Checks Flow

```mermaid
flowchart TD
    Start[Upstream Update] --> Fetch[Fetch Upstream]
    Fetch --> Branch[Create Sync Branch]
    Branch --> Merge[Merge Changes]
    Merge --> Custom{Custom Files<br/>Conflict?}

    Custom -->|Yes| Restore[Restore Custom Files]
    Custom -->|No| Tests
    Restore --> Tests[Run CI Tests]

    Tests -->|Pass| CreatePR[Create Pull Request]
    Tests -->|Fail| Issue[Create Issue<br/>Manual Fix Required]

    CreatePR --> Review{Human Review}
    Review -->|Approve| Final[Merge to Main]
    Review -->|Request Changes| Fix[Developer Fixes]
    Review -->|Reject| Close[Close PR]

    Fix --> Tests
    Final --> Downstream[Trigger Downstream Sync]

    Issue --> Manual[Manual Resolution]
    Manual --> Tests
```

## Protected Files Strategy

```
Repository Structure:
├── docs/
│   ├── 01-getting-started/     ⛔ NEVER synced (project-specific)
│   ├── 02-development/         Synced from upstream
│   ├── 03-architecture/        Synced from upstream
│   ├── 04-frontend/            Synced from upstream
│   ├── 06-operations/          Synced from upstream
│   ├── 07-deployment/          Synced from upstream
│   ├── 08-analytics/           Synced from upstream
│   ├── 09-saas-specific/       ⛔ NEVER synced (template-specific)
│   ├── 10-ai-workflow/         Synced from upstream
│   └── rules/                  Synced from upstream
└── CLAUDE.md                   Synced (with merge strategy)
```

## Approval Gate Workflow

```mermaid
stateDiagram-v2
    [*] --> Detected: Upstream Update
    Detected --> Building: Create Sync PR
    Building --> Testing: Run CI

    Testing --> Passed: Tests Pass
    Testing --> Failed: Tests Fail

    Failed --> Issue: Create Issue
    Issue --> Manual: Manual Fix
    Manual --> Testing

    Passed --> Review: Awaiting Approval
    Review --> Approved: Human Approves
    Review --> Changes: Request Changes
    Review --> Rejected: Reject

    Changes --> Testing
    Approved --> Merged: Merge to Main
    Rejected --> Closed
    Merged --> [*]
    Closed --> [*]
```

## Update Propagation Timeline

```
Base Template Update
        ↓
    [1 minute]
        ↓
Webhook Triggered
        ↓
    [2 minutes]
        ↓
Sync PR Created
        ↓
    [5 minutes]
        ↓
CI Tests Complete
        ↓
    [Human Time]
        ↓
Developer Reviews
        ↓
    [1 minute]
        ↓
Approved & Merged
        ↓
    [1 minute]
        ↓
Downstream Triggered

Total Automated Time: ~10 minutes
Total with Human Review: Hours to days (depends on team)
```
