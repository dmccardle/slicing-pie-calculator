# Implementation Plan: Cliff and Vesting Projections

**Branch**: `003-cliff-vesting-projections` | **Date**: 2025-12-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-cliff-vesting-projections/spec.md`

## Summary

Add cliff and vesting functionality to track when contributors' equity becomes fully vested. Users can configure start date, cliff period, and vesting period for each contributor. A new Projections tab shows future equity distribution at selected dates. The feature is toggleable via settings (with environment variable default) to preserve the simple mode for users who don't need vesting.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode)
**Framework**: Next.js 16.x (App Router) + React 19
**Primary Dependencies**: React Context, existing useLocalStorage and useEntities hooks
**Storage**: localStorage via existing hooks
**Styling**: Tailwind CSS 4.x
**Charts**: Recharts (existing)
**Testing**: Vitest + React Testing Library
**Target Platform**: Web (responsive: mobile, tablet, desktop)
**Project Type**: Web application (client-side only)
**Performance Goals**: Projection calculations < 1 second
**Constraints**: Offline-capable, no backend dependencies
**Scale/Scope**: Single-user local application

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Local-First Architecture | PASS | All vesting data stored in localStorage |
| II. Reusable Infrastructure | PASS | Uses existing useLocalStorage, extends useEntities |
| III. Responsive Design | PASS | Projections page will be responsive across all breakpoints |
| IV. Export System | N/A | Not directly affected; existing exports continue to work |
| V. Simplicity Over Features | PASS | No new libraries; React Context + hooks only |
| VI. Technology Stack | PASS | Uses approved technologies only |

**Result**: All gates pass. No violations to justify.

## Project Structure

### Documentation (this feature)

```text
specs/003-cliff-vesting-projections/
├── plan.md              # This file
├── spec.md              # Feature specification
├── checklists/          # Validation checklists
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── app/
│   ├── projections/
│   │   └── page.tsx           # NEW: Projections page with date selector
│   └── settings/
│       └── page.tsx           # MODIFY: Add vesting feature toggle
├── components/
│   ├── slicing-pie/
│   │   ├── ContributorForm.tsx    # MODIFY: Add vesting fields
│   │   ├── ContributorCard.tsx    # MODIFY: Show vesting status
│   │   └── VestingProgress.tsx    # NEW: Vesting progress indicator
│   └── projections/
│       ├── ProjectionChart.tsx    # NEW: Vested/unvested pie chart
│       └── DateSelector.tsx       # NEW: Date picker with presets
├── context/
│   └── SlicingPieContext.tsx  # MODIFY: Add vesting computed values
├── hooks/
│   ├── useFeatureFlags.ts     # NEW: Feature flag management
│   └── useVesting.ts          # NEW: Vesting calculation hook
├── types/
│   └── slicingPie.ts          # MODIFY: Add VestingConfig to Contributor
└── utils/
    └── vesting.ts             # NEW: Vesting calculation utilities
```

**Structure Decision**: Extends existing Next.js App Router structure. New Projections page at `/projections`. Vesting utilities isolated for reusability.

## Implementation Approach

### Phase 1: Feature Flag & Settings (US1)
1. Create `useFeatureFlags` hook with `vestingEnabled` flag
2. Add environment variable `NEXT_PUBLIC_VESTING_ENABLED` support
3. Add settings toggle for vesting features
4. Conditionally render vesting UI based on flag

### Phase 2: Contributor Vesting Data (US2)
1. Extend `Contributor` type with optional vesting fields
2. Update `ContributorForm` with vesting inputs
3. Create vesting calculation utilities
4. Update `ContributorCard` to show vesting status

### Phase 3: Dashboard Vesting Visualization (US3)
1. Create `VestingProgress` component
2. Modify dashboard pie chart to show vested/unvested
3. Add vesting status to contributor breakdown

### Phase 4: Projections Page (US4)
1. Create `/projections` page
2. Create `DateSelector` with presets (6mo, 1yr, 2yr, 5yr)
3. Create `ProjectionChart` showing projected equity
4. Wire up date selection to recalculate projections

## Key Data Model Changes

### Contributor Extension

```typescript
interface VestingConfig {
  startDate: string;      // ISO date (YYYY-MM-DD)
  cliffMonths: number;    // 0-24 typical
  vestingMonths: number;  // 12-48 typical
}

interface Contributor extends BaseEntity {
  // ... existing fields
  vesting?: VestingConfig;  // Optional for backward compatibility
}
```

### Computed Vesting Status

```typescript
type VestingState = 'none' | 'preCliff' | 'vesting' | 'fullyVested';

interface VestingStatus {
  state: VestingState;
  percentVested: number;       // 0-100
  vestedSlices: number;
  unvestedSlices: number;
  cliffDate: string | null;
  fullVestDate: string | null;
  monthsUntilCliff: number;
  monthsUntilFullVest: number;
}
```

## Complexity Tracking

> No violations to justify. Implementation uses existing patterns.

| Item | Approach | Rationale |
|------|----------|-----------|
| Vesting calculations | Pure utility functions | Keeps logic testable and reusable |
| Feature flag | Custom hook + env var | Follows existing AI settings pattern |
| Projections page | New route | Clean separation from dashboard |
