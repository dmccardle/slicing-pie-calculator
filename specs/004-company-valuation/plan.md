# Implementation Plan: Company Valuation Configuration

**Branch**: `004-company-valuation` | **Date**: 2025-12-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-company-valuation/spec.md`

## Summary

Add company valuation configuration to the Slicing Pie app with two modes: manual entry and auto-calculation based on business metrics. Includes a dedicated Equity Values page with sortable table showing contributor stakes in dollar terms. The entire feature is toggleable via feature flag (following the existing vesting feature pattern).

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode)
**Primary Dependencies**: Next.js 16 (App Router), React 19, Tailwind CSS 4
**Storage**: localStorage (via existing useLocalStorage hook)
**Testing**: Vitest + React Testing Library (per constitution)
**Target Platform**: Web (responsive: mobile, tablet, desktop)
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: Table loads < 1 second for 100 contributors, sorting < 200ms
**Constraints**: Offline-capable, no backend, local-first architecture
**Scale/Scope**: Up to 100 contributors, 20 valuation history entries

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Local-First Architecture | PASS | Uses localStorage exclusively, no backend |
| II. Reusable Infrastructure | PASS | Extends existing useFeatureFlags, useLocalStorage hooks |
| III. Responsive Design | PASS | Equity Values page follows existing responsive patterns |
| IV. Export System | N/A | Valuation data included in existing JSON export |
| V. Simplicity Over Features | PASS | React Context + hooks, Tailwind CSS, no new libraries |
| VI. Technology Stack | PASS | Uses existing stack: Next.js 16, React 19, TypeScript, Tailwind |

**Gate Result**: PASS - All applicable principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/004-company-valuation/
├── plan.md              # This file
├── research.md          # Valuation formula research
├── data-model.md        # ValuationConfig, BusinessMetrics entities
├── quickstart.md        # Testing scenarios
├── contracts/           # N/A (no API - local-first)
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── app/
│   ├── equity-values/
│   │   └── page.tsx           # NEW: Equity Values page with sortable table
│   └── settings/
│       └── page.tsx           # MODIFY: Add valuation toggle and config
├── components/
│   ├── ui/
│   │   └── SortableTable.tsx  # NEW: Generic sortable table component
│   └── valuation/
│       ├── ValuationConfig.tsx      # NEW: Manual/auto config form
│       ├── ValuationDisclaimer.tsx  # NEW: Legal disclaimer component
│       ├── BusinessMetricsForm.tsx  # NEW: Net profit, churn inputs
│       └── ValuationHistory.tsx     # NEW: History display with restore
├── context/
│   └── FeatureFlagsContext.tsx      # MODIFY: Add valuationEnabled
├── hooks/
│   ├── useFeatureFlags.ts           # MODIFY: Add valuationEnabled flag
│   └── useValuation.ts              # NEW: Valuation config management
├── types/
│   └── valuation.ts                 # NEW: ValuationConfig, BusinessMetrics types
└── utils/
    └── valuation.ts                 # NEW: Calculation formulas, formatting
```

**Structure Decision**: Follows existing project patterns. Valuation-specific components isolated in `src/components/valuation/`. New page at `/equity-values` route. Extends existing feature flags pattern.

## Complexity Tracking

No constitution violations. No complexity tracking needed.

## Files to Create/Modify Summary

| File | Action | Purpose |
|------|--------|---------|
| `src/types/valuation.ts` | CREATE | Type definitions for valuation entities |
| `src/utils/valuation.ts` | CREATE | Calculation utilities and formatters |
| `src/hooks/useValuation.ts` | CREATE | Valuation config hook with localStorage |
| `src/hooks/useFeatureFlags.ts` | MODIFY | Add valuationEnabled flag |
| `src/context/FeatureFlagsContext.tsx` | MODIFY | Add valuationEnabled to context |
| `src/components/ui/SortableTable.tsx` | CREATE | Reusable sortable table component |
| `src/components/valuation/ValuationDisclaimer.tsx` | CREATE | Legal disclaimer display |
| `src/components/valuation/ValuationConfig.tsx` | CREATE | Manual/auto mode selector |
| `src/components/valuation/BusinessMetricsForm.tsx` | CREATE | Business metrics input form |
| `src/components/valuation/ValuationHistory.tsx` | CREATE | History log with restore |
| `src/app/equity-values/page.tsx` | CREATE | Equity Values page |
| `src/app/settings/page.tsx` | MODIFY | Add valuation settings section |
| `src/components/layout/Sidebar.tsx` | MODIFY | Add Equity Values nav item (conditional) |
