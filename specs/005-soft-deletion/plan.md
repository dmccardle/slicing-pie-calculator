# Implementation Plan: Soft Deletion

**Branch**: `005-soft-deletion` | **Date**: 2025-12-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-soft-deletion/spec.md`

## Summary

Add soft deletion capability for contributors and contributions. When items are deleted, they are marked with a `deletedAt` timestamp rather than being removed from storage. Deleting a contributor cascades to their contributions. A "Deleted Items" view allows viewing and restoring soft-deleted items. Activity events track deletion and restoration actions.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode)
**Primary Dependencies**: Next.js 16 (App Router), React 19, Tailwind CSS 4
**Storage**: Browser localStorage (via existing useLocalStorage and useEntities hooks)
**Testing**: Vitest + React Testing Library
**Target Platform**: Web browser (offline-capable)
**Project Type**: Single Next.js web application
**Performance Goals**: Deletion/restoration operations complete in < 1 second
**Constraints**: Offline-capable, localStorage size limits (~5MB), no backend
**Scale/Scope**: Single-user application, ~100 contributors, ~1000 contributions

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Local-First Architecture | PASS | All data remains in localStorage, no backend required |
| II. Reusable Infrastructure | PASS | Extends existing useEntities hook pattern, reuses UI components |
| III. Responsive Design | PASS | Trash view uses existing responsive patterns (Card, Table) |
| IV. Export System | PASS | Soft-deleted items can be included/excluded from exports |
| V. Simplicity Over Features | PASS | Uses React Context + hooks, no external state libraries |
| VI. Technology Stack | PASS | All required technologies already in use |

**Result**: All gates PASS. No violations to justify.

## Project Structure

### Documentation (this feature)

```text
specs/005-soft-deletion/
├── plan.md              # This file
├── data-model.md        # Entity definitions
├── quickstart.md        # Testing scenarios
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (files to modify/create)

```text
src/
├── types/
│   └── slicingPie.ts         # MODIFY: Add deletedAt, deletedWithParent fields
├── hooks/
│   ├── useEntities.ts        # MODIFY: Add softDelete, restore, getDeleted functions
│   └── useActivityLog.ts     # CREATE: Activity event tracking hook
├── utils/
│   ├── slicingPie.ts         # MODIFY: Filter out deleted items in calculations
│   └── vesting.ts            # MODIFY: Exclude deleted from vesting calculations
├── context/
│   └── SlicingPieContext.tsx # MODIFY: Add soft delete operations, filter deleted
├── components/
│   └── slicing-pie/
│       ├── DeletedItemsList.tsx    # CREATE: Trash view component
│       ├── ActivityLog.tsx         # CREATE: Activity event display
│       └── RestoreButton.tsx       # CREATE: Restore action button
└── app/
    └── deleted/
        └── page.tsx          # CREATE: Deleted Items page (/deleted route)
```

**Structure Decision**: Extends existing Next.js App Router structure. New components follow established patterns in `/components/slicing-pie/`. New page at `/deleted` follows existing route patterns.

## Files to Modify

| File | Change Type | Purpose |
|------|-------------|---------|
| `src/types/slicingPie.ts` | MODIFY | Add SoftDeletable interface, extend Contributor/Contribution |
| `src/hooks/useEntities.ts` | MODIFY | Add softDelete, restore, getDeleted, getActive methods |
| `src/hooks/useActivityLog.ts` | CREATE | Track deletion/restoration events |
| `src/utils/slicingPie.ts` | MODIFY | Filter deleted items from calculations |
| `src/utils/vesting.ts` | MODIFY | Exclude deleted from vesting projections |
| `src/context/SlicingPieContext.tsx` | MODIFY | Wire up soft delete, expose filtered data |
| `src/components/slicing-pie/DeletedItemsList.tsx` | CREATE | Display deleted items with restore actions |
| `src/components/slicing-pie/ActivityLog.tsx` | CREATE | Show deletion/restoration activity |
| `src/components/slicing-pie/EquitySummary.tsx` | MODIFY | Include deletion events in recent activity |
| `src/components/layout/Sidebar.tsx` | MODIFY | Add "Deleted Items" nav link |
| `src/app/deleted/page.tsx` | CREATE | Deleted Items page with trash view |

## Implementation Approach

### Phase 1: Core Soft Delete (US1, US2)
1. Extend types with `deletedAt` and `deletedWithParent` fields
2. Modify useEntities hook to support soft deletion
3. Update context to use soft delete instead of hard delete
4. Ensure equity calculations exclude deleted items

### Phase 2: Trash View (US3)
1. Create DeletedItemsList component
2. Create /deleted page
3. Add navigation link to sidebar

### Phase 3: Restoration (US4)
1. Add restore functionality to useEntities
2. Create RestoreButton component
3. Handle cascade restoration for contributors

### Phase 4: Activity Tracking (US5)
1. Create useActivityLog hook
2. Create ActivityLog component
3. Integrate with dashboard Recent Activity

### Phase 5: Polish
1. Add permanent delete (hard delete) option
2. Empty trash confirmation
3. Update exports to handle deleted items

## Complexity Tracking

No violations to justify - all implementations follow existing patterns and constitution principles.
